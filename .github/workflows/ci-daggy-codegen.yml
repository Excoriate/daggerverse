---
name: ğŸ—ï¸ CI CodeGen Daggy
on:
  workflow_dispatch:
    inputs:
      dag_version:
        description: Dagger version to use
        required: false
        default: 0.14.0
  schedule:
    - cron: 0 8,20 * * *  # Runs at 8:00 AM and 8:00 PM UTC
  push:
    paths: [.daggerx/**, module-template/**]
env:
  GO_VERSION: ~1.22
  DAG_VERSION: ${{ github.event.inputs.dag_version || '0.14.0' }}
  RUST_VERSION: 1.74.0
  MODULE_NAME: mymoduleci
  GOLANGCI_LINT_VERSION: v1.62.0
permissions:
  contents: read
  id-token: write
jobs:
  codegen:
    name: ğŸ¨ Generate Module
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      - name: ğŸ¦€ Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          override: true
      - name: ğŸ› ï¸ Set up environment
        run: |
          sudo apt-get update
          sudo apt-get install jq
          curl -L https://dl.dagger.io/dagger/install.sh | DAGGER_VERSION=${{ env.DAG_VERSION }} sh
          sudo mv bin/dagger /usr/local/bin/
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          echo "ğŸ”§ Environment setup complete"
      - name: ğŸ³ Verify Dagger CLI
        run: |
          dagger version
          if [[ $(dagger version | grep -oP '(?<=dagger v)\S+') != "${{ env.DAG_VERSION }}" ]]; then
            echo "::error::âŒ Installed Dagger version does not match DAG_VERSION"
            exit 1
          fi
          echo "âœ… Dagger CLI verified successfully"
      - name: ğŸ—ï¸ Generate Module Full
        run: |
          echo "Creating a new module: ${{ env.MODULE_NAME }}..."
          cd .daggerx/daggy && cargo build --release
          cd ../..
          ./.daggerx/daggy/target/release/daggy --task=create --module=${{ env.MODULE_NAME }}
          echo "âœ… Module ${{ env.MODULE_NAME }} created successfully"
      - name: ğŸ“¦ Upload generated module
        uses: actions/upload-artifact@v3
        with:
          name: generated-module
          path: ${{ env.MODULE_NAME }}
  ci-main:
    name: ğŸ§ª CI Main Module
    needs: codegen
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      - name: ğŸ“¦ Download generated module
        uses: actions/download-artifact@v3
        with:
          name: generated-module
          path: ${{ env.MODULE_NAME }}
      - name: ğŸ› ï¸ Set up environment
        run: |
          sudo apt-get update
          sudo apt-get install jq
          curl -L https://dl.dagger.io/dagger/install.sh | DAGGER_VERSION=${{ env.DAG_VERSION }} sh
          sudo mv bin/dagger /usr/local/bin/
      - name: ğŸ› ï¸ Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin ${{ env.GOLANGCI_LINT_VERSION }}
          sudo mv $(go env GOPATH)/bin/golangci-lint /usr/local/bin/
          golangci-lint --version
      - name: ğŸ—ï¸ Build Main Module
        run: |
          cd ${{ env.MODULE_NAME }}
          dagger develop
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: ğŸ§¹ Lint Main Module
        run: |
          cd ${{ env.MODULE_NAME }}
          golangci-lint run --config=../.golangci.yml --verbose
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  ci-test:
    name: ğŸ§ª CI Test Module
    needs: codegen
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      - name: ğŸ“¦ Download generated module
        uses: actions/download-artifact@v3
        with:
          name: generated-module
          path: ${{ env.MODULE_NAME }}
      - name: ğŸ› ï¸ Set up environment
        run: |
          sudo apt-get update
          sudo apt-get install jq
          curl -L https://dl.dagger.io/dagger/install.sh | DAGGER_VERSION=${{ env.DAG_VERSION }} sh
          sudo mv bin/dagger /usr/local/bin/
      - name: ğŸ› ï¸ Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin ${{ env.GOLANGCI_LINT_VERSION }}
          sudo mv $(go env GOPATH)/bin/golangci-lint /usr/local/bin/
          golangci-lint --version
      - name: ğŸ—ï¸ Build Test Module
        run: |
          cd ${{ env.MODULE_NAME }}/tests
          dagger develop
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: ğŸ§¹ Lint Test Module
        run: |
          cd ${{ env.MODULE_NAME }}/tests
          golangci-lint run --config=../../.golangci.yml --verbose
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: ğŸ§ª Run Tests
        run: |
          cd ${{ env.MODULE_NAME }}/tests
          dagger functions
          dagger call test-all
  ci-examples:
    name: ğŸ§ª CI Examples Module
    needs: codegen
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      - name: ğŸ“¦ Download generated module
        uses: actions/download-artifact@v3
        with:
          name: generated-module
          path: ${{ env.MODULE_NAME }}
      - name: ğŸ› ï¸ Set up environment
        run: |
          sudo apt-get update
          sudo apt-get install jq
          curl -L https://dl.dagger.io/dagger/install.sh | DAGGER_VERSION=${{ env.DAG_VERSION }} sh
          sudo mv bin/dagger /usr/local/bin/
      - name: ğŸ› ï¸ Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin ${{ env.GOLANGCI_LINT_VERSION }}
          sudo mv $(go env GOPATH)/bin/golangci-lint /usr/local/bin/
          golangci-lint --version
      - name: ğŸ—ï¸ Build Examples Module
        run: |
          cd ${{ env.MODULE_NAME }}/examples/go
          dagger develop
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: ğŸ§¹ Lint Examples Module
        run: |
          cd ${{ env.MODULE_NAME }}/examples/go
          golangci-lint run --config=../../../.golangci.yml --verbose
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: ğŸ“š Run Examples
        run: |
          cd ${{ env.MODULE_NAME }}/examples/go
          dagger call all-recipes
  notify:
    name: ğŸ“¢ Notification
    needs: [ci-main, ci-test, ci-examples]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ğŸ‰ CI Success Notification
        if: needs.ci-main.result == 'success' && needs.ci-test.result == 'success'
          && needs.ci-examples.result == 'success'
        run: echo "::notice::ğŸŠ CI for ${{ env.MODULE_NAME }} completed successfully!"
      - name: âŒ CI Failure Notification
        if: needs.ci-main.result == 'failure' || needs.ci-test.result == 'failure'
          || needs.ci-examples.result == 'failure'
        run: echo "::error::ğŸ’¥ CI for ${{ env.MODULE_NAME }} failed. Please check the
          logs for details."
